FROM php:8.3.9-alpine3.20

LABEL Maintainer="Kazem Mirzaei <k90mirzaei@gmail.com>"
LABEL Description="PHP-FPM v8.3 with essential extensions and FFmpeg with libfdk-aac support on Alpine Linux."

ENV USER www
ENV GROUP www

USER root

# Install runtime and build dependencies
RUN set -ex \
    && apk update && apk upgrade \
    && apk add --no-cache \
        autoconf \
        curl-dev \
        freetype \
        freetype-dev \
        g++ \
        gcc \
        gettext \
        gettext-dev \
        git \
        gmp \
        gmp-dev \
        icu-libs \
        icu-dev \
        imagemagick \
        imagemagick-dev \
        imap \
        imap-dev \
        krb5-dev \
        libc-dev \
        libintl \
        libjpeg-turbo \
        libjpeg-turbo-dev \
        libpng \
        libpng-dev \
        libwebp-dev \
        libxml2-dev \
        libxpm \
        libxpm-dev \
        libxslt \
        libxslt-dev \
        libzip \
        libzip-dev \
        make \
        mysql-client \
        pcre-dev \
        pkgconf \
        tzdata \
        zlib-dev

# Install PHP extensions
RUN ln -s /usr/lib/$(apk --print-arch)-linux-gnu/libXpm.* /usr/lib/ \
    && docker-php-ext-configure gd --with-webp --with-jpeg --with-xpm --with-freetype --enable-gd-jis-conv \
    && docker-php-ext-install -j$(nproc) gd

RUN docker-php-ext-install -j$(nproc) gettext gmp bcmath exif intl pdo pdo_mysql pcntl zip

RUN docker-php-ext-configure imap --with-kerberos --with-imap-ssl \
    && docker-php-ext-install -j$(nproc) imap

# Install required libraries for imagick
RUN apk add --no-cache imagemagick imagemagick-dev

# Install imagick and redis extensions separately
RUN pecl install imagick \
    && docker-php-ext-enable imagick

RUN pecl install redis \
    && docker-php-ext-enable redis

# Compile and install FFmpeg with libfdk-aac support
RUN mkdir -p /usr/src/ffmpeg \
    && cd /usr/src/ffmpeg \
    && wget https://ffmpeg.org/releases/ffmpeg-snapshot.tar.bz2 \
    && tar xjf ffmpeg-snapshot.tar.bz2 \
    && cd ffmpeg \
    && ./configure --prefix=/usr \
        --enable-gpl \
        --enable-nonfree \
        --enable-libfdk-aac \
        --enable-libmp3lame \
        --enable-libass \
        --enable-libvpx \
        --enable-libx264 \
        --enable-libwebp \
        --enable-libvorbis \
        --enable-libtheora \
        --enable-opus \
    && make -j$(nproc) \
    && make install \
    && cd / \
    && rm -rf /usr/src/ffmpeg

# Install Composer
RUN wget https://raw.githubusercontent.com/composer/getcomposer.org/76a7060ccb93902cd7576b67264ad91c8a2700e2/web/installer -O - -q | php -- --quiet \
    && mv composer.phar /usr/local/bin/composer \
    && addgroup -S composer \
    && adduser -S composer -G composer \
    && composer --version

# Expose PHP-FPM port
EXPOSE 9000

# Start PHP-FPM
CMD ["php-fpm"]
